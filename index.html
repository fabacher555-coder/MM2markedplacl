import React, { useState, useEffect } from "react";
import { User } from "@/entities/User";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Plus } from "lucide-react";

// PayPal SDK laden
const loadPaypalScript = (clientId) => {
  return new Promise((resolve) => {
    if (document.getElementById("paypal-sdk")) {
      resolve(window.paypal);
      return;
    }
    const script = document.createElement("script");
    script.id = "paypal-sdk";
    script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=USD`;
    script.onload = () => resolve(window.paypal);
    document.body.appendChild(script);
  });
};

export default function Wallet() {
  const [user, setUser] = useState(null);
  const [amount, setAmount] = useState("");
  const [loading, setLoading] = useState(false);
  const [paypalLoaded, setPaypalLoaded] = useState(false);
  const clientId = "AZLjLoylhP8trchxDw9BolwD2rlIzZVbYyBCbAvgtZ8r2ndbmc49l4RXlBChcNJ9Prx2Jf5_RnsdnEz_";

  useEffect(() => {
    loadUser();
    loadPaypal();
  }, []);

  const loadUser = async () => {
    const currentUser = await User.me();
    setUser(currentUser);
  };

  const loadPaypal = async () => {
    await loadPaypalScript(clientId);
    setPaypalLoaded(true);
  };

  const addFunds = async (value) => {
    setLoading(true);
    await new Promise((resolve) => setTimeout(resolve, 500));
    await User.updateMyUserData({
      wallet_balance: (user.wallet_balance || 0) + value,
    });
    loadUser();
    setAmount("");
    setLoading(false);
  };

  const renderPaypalButton = () => {
    if (!paypalLoaded || !amount || parseFloat(amount) <= 0) return;

    const paypalContainer = document.getElementById("paypal-button-container");
    paypalContainer.innerHTML = "";

    window.paypal.Buttons({
      style: { layout: "vertical", color: "blue", shape: "rect", label: "paypal" },
      createOrder: (data, actions) => {
        return actions.order.create({
          purchase_units: [
            {
              amount: {
                value: parseFloat(amount).toFixed(2),
              },
            },
          ],
        });
      },
      onApprove: async (data, actions) => {
        const details = await actions.order.capture();
        await addFunds(parseFloat(amount));
        alert(`Zahlung erfolgreich: $${amount}`);
      },
      onError: (err) => {
        console.error(err);
        alert("PayPal-Zahlung fehlgeschlagen.");
      },
    }).render("#paypal-button-container");
  };

  useEffect(() => {
    renderPaypalButton();
  }, [amount, paypalLoaded]);

  if (!user) {
    return (
      <div className="min-h-screen bg-[#0d0d0d] flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#0d0d0d]">
      <div className="max-w-2xl mx-auto px-4 py-8">
        <h1 className="text-3xl font-bold text-white mb-8">Wallet</h1>

        {/* Balance */}
        <Card className="bg-gradient-to-br from-blue-600 to-purple-600 border-0 p-8 text-center mb-6">
          <p className="text-white/80 text-sm mb-2">Current Balance</p>
          <p className="text-white text-5xl font-bold">${user.wallet_balance?.toFixed(2) || "0.00"}</p>
        </Card>

        {/* Add Funds */}
        <Card className="bg-[#1a1a1a] border-gray-800 p-6">
          <h3 className="text-white font-semibold mb-4">Add Funds</h3>
          <div className="grid grid-cols-3 gap-3 mb-4">
            {[10, 25, 50, 100, 250, 500].map((value) => (
              <Button
                key={value}
                onClick={() => setAmount(value.toString())}
                className="bg-blue-600 hover:bg-blue-700 text-white"
              >
                ${value}
              </Button>
            ))}
          </div>
          <div className="mb-4">
            <Input
              placeholder="Custom amount"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              className="bg-[#252525] border-gray-700 text-white"
            />
          </div>
          <div id="paypal-button-container"></div>
        </Card>
      </div>
    </div>
  );
}
