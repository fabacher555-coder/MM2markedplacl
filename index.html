<script>
const STORAGE = {ITEMS:'items',CART:'cart',WALLET:'wallet',INV:'inventory'};
let items=[{id:'sunset',name:'Sunset',price:150,image:'https://via.placeholder.com/300x160?text=Sunset'}];
let cart=JSON.parse(localStorage.getItem(STORAGE.CART))||[];
let wallet=parseFloat(localStorage.getItem(STORAGE.WALLET)||0);
let inventory=JSON.parse(localStorage.getItem(STORAGE.INV))||[];

function save(){
  localStorage.setItem(STORAGE.CART,JSON.stringify(cart));
  localStorage.setItem(STORAGE.WALLET,wallet.toFixed(2));
  localStorage.setItem(STORAGE.INV,JSON.stringify(inventory));
}
function $(s){return document.querySelector(s);}
function $all(s){return document.querySelectorAll(s);}

function renderShop(){
  const g=$('#shopGrid');g.innerHTML='';
  items.forEach(it=>{
    const d=document.createElement('div');d.className='card';
    d.innerHTML=`<img src="${it.image}"><div class="title">${it.name}</div><div class="price">$${it.price}</div>
    <div class="actions"><button class="btn" onclick='addToCart("${it.id}")'>ðŸ›’ Kaufen</button></div>`;
    g.appendChild(d);
  });
  updateWallet();
}
function addToCart(id){const it=items.find(x=>x.id===id);if(it){cart.push(it);save();renderCart();}}
function renderCart(){
  const el=$('#cartContent');
  if(cart.length===0){el.innerHTML='Dein Warenkorb ist leer';return;}
  let sum=0;let html='<ul>';
  cart.forEach((c,i)=>{sum+=c.price;html+=`<li>${c.name} â€” $${c.price}<button class="btn secondary" onclick="removeFromCart(${i})">x</button></li>`});
  html+=`</ul><div><strong>Summe: $${sum}</strong></div><button class="btn" onclick="checkout()">Mit Wallet kaufen</button>`;
  el.innerHTML=html;
}
function removeFromCart(i){cart.splice(i,1);save();renderCart();}
function checkout(){
  const total=cart.reduce((s,i)=>s+i.price,0);
  if(wallet<total){alert('Nicht genug Guthaben! Lade zuerst mit PayPal auf.');return;}
  wallet-=total;
  inventory.push(...cart); // Gekaufte Items ins Inventar
  cart=[];
  save();renderCart();updateWallet();alert('Kauf erfolgreich!');
}
function updateWallet(){
  $('#walletDisplay').textContent=`$${wallet.toFixed(2)}`;
  $('#walletBig').textContent=`$${wallet.toFixed(2)}`;
  $('#walletDisplayProfile').textContent=`$${wallet.toFixed(2)}`;
}

// Wallet Betrag setzen
function setAmount(v){$('#amountInput').value=v;}

// PayPal Buttons
function renderPayPal(){
  if(!window.paypal) return;
  paypal.Buttons({
    createOrder:(data,actions)=>{
      const amt=parseFloat($('#amountInput').value||0);
      if(!amt||amt<=0){alert('Bitte Betrag eingeben');return Promise.reject();}
      return actions.order.create({purchase_units:[{amount:{value:amt.toString()}}]});
    },
    onApprove:(data,actions)=>{
      return actions.order.capture().then(function(){
        const amt=parseFloat($('#amountInput').value||0);
        wallet+=amt;save();updateWallet();alert('Wallet aufgeladen: $'+amt);
      });
    }
  }).render('#paypal-button-container');
}

// INVENTORY
function renderInventory(){
  const grid=$('#inventoryGrid');grid.innerHTML='';
  if(inventory.length===0){grid.innerHTML='<div>Du hast noch keine Items.</div>';return;}
  inventory.forEach(it=>{
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`<img src="${it.image}"><div class="title">${it.name}</div>`;
    grid.appendChild(div);
  });
}

// Navigation
$all('.nav button').forEach(b=>b.addEventListener('click',()=>switchPage(b.getAttribute('data-page'))));
function switchPage(p){
  $all('.page').forEach(x=>x.style.display='none');
  $('#page-'+p).style.display='block';
  $all('.nav button').forEach(x=>x.classList.remove('active'));
  document.querySelector(`[data-page="${p}"]`).classList.add('active');
  if(p==='shop')renderShop();
  if(p==='cart')renderCart();
  if(p==='wallet')renderPayPal();
  if(p==='inventori')renderInventory();
}
renderShop();renderCart();updateWallet();
</script>
