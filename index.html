import React, { useState, useEffect } from "react";
import { User } from "@/entities/User";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";

// PayPal Script Loader
const loadPayPalScript = (clientId) => {
  return new Promise((resolve, reject) => {
    if (document.getElementById("paypal-sdk")) {
      resolve();
      return;
    }
    const script = document.createElement("script");
    script.id = "paypal-sdk";
    script.src = https://www.paypal.com/sdk/js?client-id=${clientId}&currency=USD;
    script.onload = resolve;
    script.onerror = reject;
    document.body.appendChild(script);
  });
};

export default function Wallet() {
  const [user, setUser] = useState(null);
  const [amount, setAmount] = useState("");
  const [loading, setLoading] = useState(false);

  const PAYPAL_CLIENT_ID =
    "AZLjLoylhP8trchxDw9BolwD2rlIzZVbYyBCbAvgtZ8r2ndbmc49l4RXlBChcNJ9Prx2Jf5_RnsdnEz_";

  useEffect(() => {
    loadUser();
    loadPayPalScript(PAYPAL_CLIENT_ID);
  }, []);

  const loadUser = async () => {
    const currentUser = await User.me();
    setUser(currentUser);
  };

  const createOrder = (data, actions) => {
    return actions.order.create({
      purchase_units: [
        {
          amount: {
            value: amount,
          },
        },
      ],
    });
  };

  const onApprove = async (data, actions) => {
    await actions.order.capture();
    // Wallet aktualisieren
    await User.updateMyUserData({
      wallet_balance: (user.wallet_balance || 0) + parseFloat(amount),
    });
    loadUser();
    setAmount("");
    alert("Zahlung erfolgreich!");
  };

  useEffect(() => {
    if (window.paypal && amount > 0) {
      window.paypal
        .Buttons({
          style: { layout: "vertical", color: "blue", shape: "rect", label: "paypal" },
          createOrder,
          onApprove,
        })
        .render("#paypal-button-container");
    }
  }, [amount, user]);

  if (!user) {
    return (
      <div className="min-h-screen bg-[#0d0d0d] flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#0d0d0d]">
      <div className="max-w-2xl mx-auto px-4 py-8">
        <h1 className="text-3xl font-bold text-white mb-8">Wallet</h1>

        {/* Balance */}
        <Card className="bg-gradient-to-br from-blue-600 to-purple-600 border-0 p-8 text-center mb-6">
          <p className="text-white/80 text-sm mb-2">Current Balance</p>
          <p className="text-white text-5xl font-bold">
            ${user.wallet_balance?.toFixed(2) || "0.00"}
          </p>
        </Card>

        {/* Add Funds */}
        <Card className="bg-[#1a1a1a] border-gray-800 p-6">
          <h3 className="text-white font-semibold mb-4">Add Funds</h3>
          <div className="mb-4">
            <input
              type="number"
              placeholder="Amount in USD"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              className="w-full bg-[#252525] border border-gray-700 text-white px-4 py-2 rounded-md"
            />
          </div>
          <div id="paypal-button-container"></div>
        </Card>
      </div>
    </div>
  );
}
